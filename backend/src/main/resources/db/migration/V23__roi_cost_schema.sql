-- ROI & Cost Tracking Schema
-- COST_CATEGORIES lookup
CREATE TABLE COST_CATEGORIES (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CODE VARCHAR2(50) NOT NULL UNIQUE,
    NAME VARCHAR2(100) NOT NULL,
    PARENT_CODE VARCHAR2(50),
    CATEGORY_TYPE VARCHAR2(30) NOT NULL -- PLATFORM / CONTENT / CAMPAIGN / OPERATIONAL
);

CREATE TABLE CAMPAIGN_COSTS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CAMPAIGN_ID NUMBER NOT NULL,
    CATEGORY_CODE VARCHAR2(50) NOT NULL,
    SUBCATEGORY VARCHAR2(100),
    COST_DATE DATE NOT NULL,
    AMOUNT NUMERIC(14,4) NOT NULL,
    CURRENCY VARCHAR2(10) NOT NULL,
    QUANTITY NUMBER(12,4),
    UNIT_COST NUMBER(14,4),
    NOTES VARCHAR2(400),
    CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL
);
DECLARE
    e_exists EXCEPTION; PRAGMA EXCEPTION_INIT(e_exists,-955);
    e_dupcols EXCEPTION; PRAGMA EXCEPTION_INIT(e_dupcols,-1408);
BEGIN
    BEGIN
        EXECUTE IMMEDIATE 'CREATE INDEX IDX_CAMPAIGN_COSTS_CAMP_DATE ON CAMPAIGN_COSTS (CAMPAIGN_ID, COST_DATE)';
    EXCEPTION
        WHEN e_exists THEN NULL;
        WHEN e_dupcols THEN NULL;
    END;
END;
/

CREATE TABLE COST_ALLOCATIONS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    RESOURCE_NAME VARCHAR2(120) NOT NULL,
    ALLOCATION_METHOD VARCHAR2(40) NOT NULL, -- HOURS, PERCENTAGE, WEIGHTED
    BASIS_VALUE NUMBER(14,6),
    TOTAL_COST NUMBER(14,4) NOT NULL,
    CURRENCY VARCHAR2(10) NOT NULL,
    PERIOD_START DATE NOT NULL,
    PERIOD_END DATE NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL
);

CREATE TABLE COST_ALLOCATION_LINKS (
    ALLOCATION_ID NUMBER NOT NULL,
    CAMPAIGN_ID NUMBER NOT NULL,
    WEIGHT_VALUE NUMBER(14,6),
    PRIMARY KEY(ALLOCATION_ID, CAMPAIGN_ID)
);

CREATE TABLE EXCHANGE_RATES (
    RATE_DATE DATE NOT NULL,
    BASE_CURRENCY VARCHAR2(10) NOT NULL,
    QUOTE_CURRENCY VARCHAR2(10) NOT NULL,
    RATE NUMBER(18,8) NOT NULL,
    SOURCE VARCHAR2(40),
    CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    PRIMARY KEY(RATE_DATE, BASE_CURRENCY, QUOTE_CURRENCY)
);
DECLARE
    e_exists EXCEPTION; PRAGMA EXCEPTION_INIT(e_exists,-955);
    e_dupcols EXCEPTION; PRAGMA EXCEPTION_INIT(e_dupcols,-1408);
BEGIN
    BEGIN
        EXECUTE IMMEDIATE 'CREATE INDEX IDX_EXCHANGE_RATES_QUOTE ON EXCHANGE_RATES (QUOTE_CURRENCY, RATE_DATE)';
    EXCEPTION
        WHEN e_exists THEN NULL;
        WHEN e_dupcols THEN NULL;
    END;
END;
/

CREATE TABLE ROI_ANALYSIS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CAMPAIGN_ID NUMBER NOT NULL,
    ANALYSIS_DATE DATE NOT NULL,
    BASE_CURRENCY VARCHAR2(10) NOT NULL,
    TOTAL_COST_BASE NUMBER(18,4) NOT NULL,
    TOTAL_REVENUE_BASE NUMBER(18,4) NOT NULL,
    ROI_PCT NUMBER(9,4) NOT NULL,
    PROFIT_MARGIN_PCT NUMBER(9,4),
    PAYBACK_DAYS NUMBER(9,2),
    LTV_ATTRIBUTED NUMBER(18,4),
    GENERATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    UNIQUE (CAMPAIGN_ID, ANALYSIS_DATE)
);
DECLARE
    e_exists EXCEPTION; PRAGMA EXCEPTION_INIT(e_exists,-955);
    e_dupcols EXCEPTION; PRAGMA EXCEPTION_INIT(e_dupcols,-1408);
BEGIN
    BEGIN
        EXECUTE IMMEDIATE 'CREATE INDEX IDX_ROI_ANALYSIS_CAMP_DATE ON ROI_ANALYSIS (CAMPAIGN_ID, ANALYSIS_DATE)';
    EXCEPTION
        WHEN e_exists THEN NULL;
        WHEN e_dupcols THEN NULL;
    END;
END;
/

-- Seed cost categories
INSERT INTO COST_CATEGORIES (CODE, NAME, CATEGORY_TYPE) VALUES ('PLATFORM_EMAIL_SEND','Email Sending','PLATFORM');
INSERT INTO COST_CATEGORIES (CODE, NAME, CATEGORY_TYPE) VALUES ('PLATFORM_STORAGE','Storage','PLATFORM');
INSERT INTO COST_CATEGORIES (CODE, NAME, CATEGORY_TYPE) VALUES ('CONTENT_DESIGN','Design Labor','CONTENT');
INSERT INTO COST_CATEGORIES (CODE, NAME, CATEGORY_TYPE) VALUES ('CONTENT_COPY','Copywriting','CONTENT');
INSERT INTO COST_CATEGORIES (CODE, NAME, CATEGORY_TYPE) VALUES ('CAMPAIGN_SEGMENT','Segmentation Analysis','CAMPAIGN');
INSERT INTO COST_CATEGORIES (CODE, NAME, CATEGORY_TYPE) VALUES ('CAMPAIGN_AB_TEST','A/B Testing','CAMPAIGN');
INSERT INTO COST_CATEGORIES (CODE, NAME, CATEGORY_TYPE) VALUES ('OPERATIONS_STAFF','Staff Time','OPERATIONAL');
INSERT INTO COST_CATEGORIES (CODE, NAME, CATEGORY_TYPE) VALUES ('OPERATIONS_TRAINING','Training','OPERATIONAL');

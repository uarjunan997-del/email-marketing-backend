-- All DDL wrapped for idempotency (ignoring existing object errors)
-- RAW_EMAIL_EVENTS table (unique index for PK auto-created; redundant explicit unique index removed to avoid ORA-01408)
BEGIN
  EXECUTE IMMEDIATE q'[
    CREATE TABLE RAW_EMAIL_EVENTS (
      EVENT_ID VARCHAR2(64) PRIMARY KEY,
      USER_ID NUMBER(19) NOT NULL,
      CAMPAIGN_ID NUMBER(19) NOT NULL,
      EVENT_TYPE VARCHAR2(40) NOT NULL,
      EVENT_TS TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
      METADATA_JSON CLOB
    )
  ]';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE IN (-955) THEN NULL; ELSE RAISE; END IF; -- ORA-00955 name already used
END;
/

-- Partition suggestion (manual apply if edition allows):
-- ALTER TABLE RAW_EMAIL_EVENTS PARTITION BY RANGE (EVENT_TS) INTERVAL (NUMTOYMINTERVAL(1,'MONTH')) (PARTITION p_seed VALUES LESS THAN (DATE '2025-01-01'));

-- ECOM_WEBHOOK_RAW table
BEGIN
  EXECUTE IMMEDIATE q'[
    CREATE TABLE ECOM_WEBHOOK_RAW (
      ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
      PROVIDER VARCHAR2(30) NOT NULL,
      EXT_ID VARCHAR2(80),
      RECEIVED_AT TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
      PAYLOAD CLOB,
      SIG_VALID CHAR(1) CHECK (SIG_VALID IN ('Y','N')),
      STATUS VARCHAR2(20) DEFAULT 'NEW',
      ERROR_MSG VARCHAR2(4000)
    )
  ]';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE IN (-955) THEN NULL; ELSE RAISE; END IF;
END;
/

-- Index on provider & received_at
BEGIN
  EXECUTE IMMEDIATE 'CREATE INDEX IDX_ECOM_WEBHOOK_PROVIDER ON ECOM_WEBHOOK_RAW(PROVIDER, RECEIVED_AT)';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE IN (-955, -1408) THEN NULL; ELSE RAISE; END IF; -- ORA-01408 duplicate column list
END;
/

-- Unique external id per provider
BEGIN
  EXECUTE IMMEDIATE 'CREATE UNIQUE INDEX IDX_ECOM_WEBHOOK_EXT ON ECOM_WEBHOOK_RAW(PROVIDER, EXT_ID)';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE IN (-955, -1408) THEN NULL; ELSE RAISE; END IF;
END;
/

-- ORDER_ATTRIBUTION table
BEGIN
  EXECUTE IMMEDIATE q'[
    CREATE TABLE ORDER_ATTRIBUTION (
      ORDER_ID VARCHAR2(64) PRIMARY KEY,
      USER_ID NUMBER(19),
      CAMPAIGN_ID NUMBER(19),
      ORDER_TS TIMESTAMP NOT NULL,
      CURRENCY VARCHAR2(10),
      GROSS_AMOUNT NUMBER(18,4),
      NET_AMOUNT NUMBER(18,4),
      ATTR_METHOD VARCHAR2(20),
      SOURCE_CHANNEL VARCHAR2(30),
      CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP
    )
  ]';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE IN (-955) THEN NULL; ELSE RAISE; END IF;
END;
/

-- Index on campaign & order_ts
BEGIN
  EXECUTE IMMEDIATE 'CREATE INDEX IDX_ATTR_CAMPAIGN ON ORDER_ATTRIBUTION(CAMPAIGN_ID, ORDER_TS)';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE IN (-955, -1408) THEN NULL; ELSE RAISE; END IF;
END;
/

-- ROI_BENCHMARKS_STAGE (create empty copy)
DECLARE
  v_exists NUMBER;
BEGIN
  SELECT COUNT(*) INTO v_exists FROM user_tables WHERE table_name = 'ROI_BENCHMARKS_STAGE';
  IF v_exists = 0 THEN
    EXECUTE IMMEDIATE 'CREATE TABLE ROI_BENCHMARKS_STAGE AS SELECT * FROM ROI_BENCHMARKS WHERE 1=0';
  END IF;
END;
/
